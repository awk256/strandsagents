
現在のBedrockエージェントにおけるガードレールの設定は、**「個別に定義したポリシーを、エージェントのプロパティとして紐付ける（アソシエーション）」**　という形で行います。

ただし、単に「組み込む」だけでなく、**「入力・出力・ツール実行」のどのタイミングでどう機能させるか**という動作の仕組みを理解しておく必要があります。

# Bedrockエージェントへのガードレール設定フロー

設定のプロセスは大きく以下の3ステップです。

### ガードレールの作成（独立した部品として）

まず、エージェントとは別に「ガードレールコンソール」でポリシーを作成します。ここで前述した「拒否トピック」や「PIIフィルタ」を定義し、**「バージョン」** を発行します（Working Draftのままではエージェントに紐付けられません）。

### エージェントへの紐付け（アソシエーション）

エージェントの設定画面にある「Guardrail details」セクションで、作成したガードレールと、使用するバージョン（またはエイリアス）を選択します。

### 呼び出し時の指定（API/SDK）

プログラム（Boto3など）からエージェントを呼び出す際、個別にガードレールを指定する必要はありません。**エージェントに紐付いていれば、`invoke_agent` 時に自動的に適用されます。**

### 設定時の「落とし穴」と注意点

エージェントに組み込む際、特に「朝まで生テレビ」のような複雑な構成では以下の点に注意してください。

- **「上書き」はできない:**

	- エージェントに紐付けたガードレール設定は、API呼び出し時に動的に「このパラメータだけOFFにする」といった変更はできません。柔軟に変えたい場合は、複数のエージェントを用意するか、プログラム側で処理を分ける必要があります。

- **Action Groupとの兼ね合い:**

	- ガードレールは「モデルがツールを呼び出そうとした引数」もチェックします。もしAction Groupの引数にPII（個人情報）が含まれる設計だと、ガードレールがツール実行自体をブロックしてしまい、処理が止まることがあります。

- ストリーミング応答への影響:

	- ガードレールを適用すると、安全性の検証を行うため、最初のレスポンスが返ってくるまでのレイテンシ（遅延）がわずかに増加します。

### マルチエージェント・コラボレーションでの挙動

ここが今回の「討論バトル」で最も重要なポイントです。

- Supervisorに設定すればOK:

    マルチエージェント構成（Collaborator）の場合、メインのSupervisor Agentにガードレールを設定すれば、そこから呼び出されるSub-Agent（パネリスト）とのやり取り全体が保護対象となります。

- バケツリレーの監視:

    SupervisorがSub-Agentに「Aさんの住所を調べて」と指示を出した場合、その指示（出力）がガードレールによって検知・遮断されます。

