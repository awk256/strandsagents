
Amazon Bedrockのガードレール設定（個別設定）における各ステップの構成手順と意味、およびテスト方法をまとめました。

# Amazon Bedrock ガードレール個別設定ガイド

### Step 1: ガードレールの詳細設定 (Provide guardrail details)

基本情報と、ルール抵触時の応答メッセージを定義します。

- **Name (名前)**: `Asanama-Debate-Guardrail`

- **Description (説明)**: 朝まで生テレビ」形式の討論用。過激な表現、個人攻撃、デタラメな数字（ハルシネーション）を抑制。

- **Blocked messaging (ブロック時のメッセージ)**:

    - **Messaging shown for blocked prompts (入力ブロック時)**: 今の質問はルール違反だよ！もっとまともな議論をしよう。

    - **Messaging shown for blocked responses (出力ブロック時)**: (田原総一朗) ちょっと待って！その発言は聞き捨てならない。番組として容認できないよ。

**※Step 6へ**
### Step 2: コンテンツフィルタの設定 (Configure content filters)

有害なコンテンツや攻撃的な入力を多層的にフィルタリングします。

- **Harmful categories (有害なカテゴリ)**:

    - ヘイト、侮辱、性的表現、暴力、不正行為の5カテゴリを監視。

    - プロンプト（入力）とレスポンス（出力）の両方に適用。

    - 強度を4段階（None/Low/Medium/High）で設定可能。

- **Prompt attacks (プロンプト攻撃)**:

    - プロンプトインジェクション（指示の上書き）を検知。

    - ジェイルブレイク（制限解除の試み）をブロック。

### Step 3: 拒否トピックの設定 (Configure denied topics)

ビジネスや番組の趣旨にそぐわない「特定の話題」を禁止します。

- **Denied topics (拒否トピック)**:

    - アプリのポリシーで禁止したいトピック（例：投資助言、特定の政治的主張）を定義。

    - 名前、詳細な定義、サンプル文を登録して検知精度を向上。

    - 該当する話題への言及を即座に遮断。

### Step 4: ワードフィルタの追加 (Add word filters)

特定の単語や表現をピンポイントで禁止します。

- **Profanity filter (不適切な言葉のフィルタ)**:

    - 一般的な卑俗語や放送禁止用語を自動でチェック。

- **Words and phrase (カスタム単語とフレーズ)**:

    - 自社特有のNGワード、競合他社名、特定の機密単語などを直接指定。

### Step 5: 秘密情報フィルタの追加 (Add sensitive information filters)

個人情報（PII）の流出を徹底的に防ぎます。

- **PII types (個人情報の種類)**:

    - 氏名、住所、電話番号、メールアドレスなどを自動検知。

    - **Action (アクション)**: 「Block（遮断）」または「Mask（置換）」を選択。

- **Regex patterns (正規表現パターン)**:

    - 社員番号やクレジットカード番号など、特定の形式を正規表現で保護。

### Step 6: コンテキストグラウンディング・チェックの追加 (Add contextual grounding check)

**ガードレールの作成には、少なくとも1つのフィルタを設定する必要があります。**

- Enable relevance check: On
- Relevance score threshold: 0.7
- Relevance action: Block


参照元データと照合し、嘘（ハルシネーション）を防ぎます。

- **Grounding check (グラウンディング・チェック)**:

    - 回答がナレッジベース等の参照ソースに基づいているかを検証。

- **Relevance check (関連性チェック)**:

    - 回答がユーザーの質問（意図）に対して論理的に関連しているかを検証。

- **Thresholds (閾値)**:

    - 各チェックにスコアを設定し、基準に満たない回答を自動でブロック。

####  ※閾値設定ガイド：コンテキストグラウンディング・チェック (Step 6)
---
ガードレールの作成には、少なくとも1つのフィルタを設定する必要があります。Step 6（コンテキストグラウンディング・チェック）における**「ハルシネーションを確実に止めるためのスコア閾値設定」**のガイドを、ステップごとに箇条書きでまとめました。

##### 1. グラウンディング・チェック (Grounding check)

**役割:** 回答が参照ソース（ナレッジベース等）の事実にどれだけ基づいているかを判定します。

- **スコア範囲:** $0.0$ (根拠なし) 〜 $1.0$ (完全な根拠あり)

- **設定の目安:**

    - **0.85 〜 1.0 (厳格):** 金融、医療、公的書類の要約など「一文字のミスも許されない」場合。

    - **0.70 〜 0.84 (標準):** **討論バトルやカスタマーサポート。** 事実を維持しつつ、自然な言い換えを許容する場合。

    - **0.60 〜 0.69 (寛容):** 雑談を交えた創作や、ソースからアイデアを広げる対話の場合。

- **アクション:** 閾値を下回った場合、回答をブロックし、Step 1で設定したメッセージを表示します。

##### 2. 関連性チェック (Relevance check)

**役割:** 回答がユーザーの質問（クエリ）に対して、論理的に「正しく答えているか」を判定します。

- **スコア範囲:** $0.0$ (無関係) 〜 $1.0$ (完全に一致)

- **設定の目安:**

    - **0.80 〜 1.0 (高):** 質問に直球で答える必要がある検索エンジンやデータ抽出。

    - **0.60 〜 0.79 (中):** **討論の司会やQ&A。** 周辺情報や背景説明の付加を許容する場合。

    - **0.40 〜 0.59 (低):** 自由なブレインストーミングや連想ゲーム。

- **アクション:** 質問の意図から外れた回答を遮断し、ユーザーの混乱を防ぎます。

##### 3. チューニングの進め方 (Tuning steps)

一発で決めるのではなく、以下のサイクルで最適化します。

- **Step A: 緩めに開始:**

    - 最初は `Grounding: 0.70` / `Relevance: 0.60` あたりからスタートし、モデルが本来出すべき回答がどれくらいのスコアになるかを確認します。

- **Step B: トレース (Trace) の確認:**

    - AWS SDK (Boto3) で `enableTrace=True` を設定して呼び出し、レスポンスに含まれる実際の計算スコア（例: `0.78` など）を観察します。

- **Step C: 境界線の特定:**

    - 「正しい回答がギリギリ通る」かつ「嘘（ハルシネーション）がギリギリ落ちる」数値を 0.05 刻みで調整します。

##### 4. 運用上の注意点

- **ナレッジベースの質に依存:**

    - 回答の根拠となるソース（KB）の文章が短すぎたり、曖昧だったりすると、正しい回答でもスコアが低く算出され、過剰にブロックされる原因になります。

- **モデルによる変動:**

    - Claude 3.5 Sonnet と Nova では、文体や密度が異なるため、同じ内容でも算出スコアが変わることがあります。モデル変更時は必ず再テストが必要です。

**※Create guardrail**

### Step 7: 自動推論チェックの追加 (Add Automated Reasoning check)

最新の技術で、回答が定義された論理的ルールに従っているかを確認します。

- **Automated Reasoning check (自動推論チェック)**:

    - 数学的・論理的推論を用い、回答内容が定義したポリシーと矛盾していないかを厳密に検証。

    - 非常に高い信頼性が求められる業務ロジックの適合性確認に使用。

## ガードレールのテスト

- #### Select model: Nova Pro
- #### Prompt: タカさん、もう、戦争だよ。
- #### Run
- #### Model response:
```
申し訳ありませんが、戦争や暴力を助長するような内容には対応できません。

現代の国際社会では、紛争や対立は外交、対話、平和的な解決方法を通じて解決すべきです。国連憲章は、加盟国間の紛争を平和的手段で解決し、国際平和と安全を維持することを目的としています。

もし何らかの対立や問題に直面している場合は、冷静な対話、交渉、または調停などの平和的な方法を模索することをお勧めします。多くの国や組織が、紛争解決を支援するためのリソースやサービスを提供しています。

また、心配やストレスを感じている場合は、信頼できる人に相談したり、専門的なサポートを求めることも大切です。平和的な解決策を見つけることで、長期的な利益と安定性を得ることができます。
```

- #### Final response:
```
申し訳ありませんが、戦争や暴力を助長するような内容には対応できません。

現代の国際社会では、紛争や対立は外交、対話、平和的な解決方法を通じて解決すべきです。国連憲章は、加盟国間の紛争を平和的手段で解決し、国際平和と安全を維持することを目的としています。

もし何らかの対立や問題に直面している場合は、冷静な対話、交渉、または調停などの平和的な方法を模索することをお勧めします。多くの国や組織が、紛争解決を支援するためのリソースやサービスを提供しています。

また、心配やストレスを感じている場合は、信頼できる人に相談したり、専門的なサポートを求めることも大切です。平和的な解決策を見つけることで、長期的な利益と安定性を得ることができます。
```


1. **コンソールでのテスト (Test guardrail)**:

    - モデルを選択し、意図的にNGな入力を投げ、どのフィルタが反応するか即座に確認。

2. **SDKによるトレース (Boto3 Trace)**:

    - `enableTrace=True` で呼び出し、バックエンドの判定理由をログとして取得。

3. **モデル評価 (Model Evaluation)**:

    - 大量のデータセットを流し込み、遮断率や誤検知率を統計的に評価。