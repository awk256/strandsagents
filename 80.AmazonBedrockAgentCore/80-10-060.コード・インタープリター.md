
AWS Bedrock AgentCoreにおける**Code Interpreter（コードインタープリター）は、エージェントがプログラム（主にPython）を生成し、それを安全に隔離されたサンドボックス環境**で実行するための機能です。

# 概要

LLMは「言葉」の処理に長けていますが、統計計算や論理演算、大規模データの加工を確率的なテキスト生成だけで行うと、誤った数値を出力（ハルシネーション）するリスクがあります。

**Code Interpreter**は、AgentCore Runtimeに統合された「内蔵ツール」です。 LangChainやStrandsといったフレームワークを使用する場合、このツールを「標準的な関数（Tool）」としてエージェントに登録します。エージェントは計算が必要な時、自身の推論（ハルシネーションのリスクあり）ではなく、この**決定論的なPython実行環境**を呼び出すことで、正確な分析結果を出力します。

---

AgentCoreが「隔離された実行環境」の中で、どのように内蔵ツールと外部リソースを統制しているかを示します。


```mermaid
graph TD
    subgraph "Local App / Developer Environment"
        Agent["AI Agent (LangChain/Strands)"]
        Data[CSV/Excel Data]
    end

    subgraph "AWS Bedrock AgentCore (Managed)"
        Runtime["AgentCore Runtime"]
        
        subgraph "Code Interpreter Sandbox"
            SB["Isolated Python Environment"]
            Store["Secure Local Storage"]
            Lib["Scientific Libraries<br/>(Pandas, Matplotlib, etc.)"]
        end
    end

    Agent -->|1.Upload File & Send Code| SB
    SB -->|2.Save File| Store
    SB -->|3.Execute Analysis| Lib
    Lib -->|4.Generate Plot / CSV| Store
    SB -->|5.Return Text & Files| Agent
```

- **Runtime（中心）:** エージェントが思考する隔離されたメインルーム。
    
- **内蔵ツール（直結）:** Code InterpreterやBrowserはRuntimeの「隣の部屋」にあり、設定なしで高速・安全に呼び出せる。
    
- **Gateway（窓口）:** 外部APIや社内DBへ繋がる唯一の「安全な出口」。
    
- **Policy（検問）:** エージェントがGatewayやツールを使う前に、ルール違反がないかチェックする「門番」。
    
- **Memory（蓄積）:** 過去の会話や学習した事実を保存し、いつでも取り出せる「外部脳」。
-
---
## 実装のポイント

- **隔離ストレージ:** サンドボックス内の `/tmp/inputs` や `/tmp/outputs` を通じてファイルの読み書きを行います。
    
- **ライブラリの事前ロード:** Pandasなどの重いライブラリを自分でインストールする必要はなく、インポートするだけで即座に使えます。
    
- **セッションの永続性:** 一連の対話（スレッド）の間、生成されたファイルは保持され、次のステップで再利用可能です

---

## 疑似コード

サンプルの「Strands Agents」および「LangChain」での利用を想定した、正しいパッケージ構成の実装例です。

### パターンA：Strands Agents（AgentCore最適化SDK）を使用

Python

```
# --- 1. 必要パッケージのインポート ---
from strands.agents import Agent
# AgentCoreの内蔵ツール（Built-ins）からCodeInterpreterをインポート
from strands.tools.builtins import CodeInterpreterTool
from langchain_aws import ChatBedrockConverse

# --- 2. ツールとモデルの準備 ---
# AWS上の隔離環境を制御するツールの実体化
code_interpreter = CodeInterpreterTool()

# 利用するモデル（Amazon Nova等）
llm = ChatBedrockConverse(model_id="amazon.nova-pro-v1:0")

# --- 3. エージェントの構築 ---
# 内蔵ツールを「装備」として登録
my_agent = Agent(
    name="DataAnalyst",
    instructions="""
    データ分析の依頼があった場合は、CodeInterpreterToolを使用して
    Pythonコードを実行し、正確な統計結果とグラフを生成してください。
    """,
    tools=[code_interpreter],
    llm=llm
)

# --- 4. 実行 ---
# エージェントは自動的にCSVをサンドボックスへ送り、コードを実行します
response = my_agent.run(
    "添付の 'sales.csv' を読み込んで、売上の月次推移を棒グラフにして。",
    files=["./data/sales.csv"] # ローカルファイルをサンドボックスへ転送
)
```

### パターンB：LangChain（汎用フレームワーク）を使用

```
# --- 1. 必要パッケージのインポート ---
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain_aws import ChatBedrockConverse
# AgentCoreのSDKからLangChain互換ツールをインポート
from bedrock_agentcore.integrations.langchain import CodeInterpreterTool

# --- 2. ツールとモデルのセットアップ ---
llm = ChatBedrockConverse(model_id="amazon.nova-pro-v1:0")
# AgentCore内蔵のCode Interpreterをツールとして定義
ci_tool = CodeInterpreterTool()
tools = [ci_tool]

# --- 3. 標準的なLangChainエージェントの作成 ---
# AgentCore固有のインフラを、LangChainの標準的な「Tool」として扱う
agent = create_tool_calling_agent(llm, tools, prompt)
agent_executor = AgentExecutor(agent=agent, tools=tools)

# --- 4. 実行 ---
agent_executor.invoke({"input": "この数式の値を求めて: sin(45) * sqrt(1024)"})
```
---

#  まとめ

Code Interpreterの疑似コードにおける「正解」は、**「自分で計算ロジックを書くのではなく、AWSが提供するツールの口（Interface）をエージェントに渡すだけ」** という点に集約されます。

- **内蔵ツール:** `from ... import CodeInterpreterTool` が示す通り、実体はAWSのマネージドなインフラです。
    
- **利便性:** 開発者は、実行環境のパッチ当てやセキュリティ対策（サンドボックス化）を一切気にせず、分析ロジックの精度向上に専念できます。

開発者は「接続」や「保護」の苦労から解放され、**「エージェントにどのような価値を提供させるか」** という本来の目的のみに集中できるようになります。
